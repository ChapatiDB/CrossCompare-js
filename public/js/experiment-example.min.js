var totalAverageDelay=dc.numberDisplay("#delay"),flightsTable=dc.dataTable("#flightsTable"),flightDelay=dc.scatterPlot("#flightDelay"),movementsChart=dc.lineChart("#movementsChart"),movementsTimeChart=dc.barChart("#movementsTimeChart"),airportsChart=dc.rowChart("#airportsChart"),weekdayChart=dc.rowChart("#weekdayChart"),todChart=dc.barChart("#todChart"),delayChart=dc.barChart("#delayChart"),distanceChart=dc.barChart("#distanceChart"),airport,airline,colorRange=["rgb(165,0,38)","rgb(215,48,39)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(217,239,139)","rgb(166,217,106)","rgb(102,189,99)","rgb(26,152,80)","rgb(0,104,55)"],dateInFormat=d3.time.format("%d-%m-%Y %H:%M"),dateOutFormat=d3.time.format("%d/%m/%Y %H:%M"),numberFormat=d3.format("0,000"),precisionFormat=d3.format(".2f"),DELAY_MIN=-60,DELAY_MAX=179,DISTANCE_MAX=2499,CHART_L=300,CHART_S=107;d3.csv("data/example.csv",function(t){function e(t,e,r){return Math.max(e,Math.min(r,t))}function r(t,e){return Math.floor(t/e)*e}function a(t){var e=t.anchorName();"none"!=$("#"+e+" > .reset").css("display")?$("#reset"+e).removeClass("disabled"):$("#reset"+e).addClass("disabled")}function n(t){var e=$("#"+t.anchorName()),r=e.children("tbody");e.append(r.get().reverse())}function o(){var t=$("#width-half").width(),e=$("#width-quarter").width();movementsChart.width(t),movementsTimeChart.width(t),flightDelay.width(t),airportsChart.width(e),weekdayChart.width(e),delayChart.width(t),todChart.width(e),distanceChart.width(e),dc.renderAll(),$(".loading").hide()}t.forEach(function(t){t.DateTime=dateInFormat.parse(t.DateTime)});var i=crossfilter(t),l=i.groupAll();airport=i.dimension(function(t){return t.Airport}),airline=i.dimension(function(t){return t.Airline});var s=i.dimension(function(t){return t.Airport2}),d=i.dimension(function(t){return t.DateTime}),c=i.dimension(function(t){return t.DateTime.getHours()}),m=i.dimension(function(t){return[t.DateTime.getHours()+r(t.DateTime.getMinutes(),5)/60,e(t.Delay,DELAY_MIN,DELAY_MAX)]}),u=i.dimension(function(t){var e=0==t.DateTime.getDay()?7:t.DateTime.getDay();return""+e+" "+d3.time.format("%A")(t.DateTime)}),f=i.dimension(function(t){return e(t.Delay,DELAY_MIN,DELAY_MAX)}),h=i.dimension(function(t){return e(t.Distance,0,DISTANCE_MAX)});byDate=d.group(d3.time.day),byDateHour=d.group(d3.time.hour),byHour=c.group(),byScndAirport=s.group(),byScatter=m.group(),byDelay=f.group(function(t){return r(t,5)}),byDistance=h.group(function(t){return r(t,100)}),byWeekday=u.group().reduce(function(t,e){return++t.n,t.sumDelay+=Number(e.Delay),t.avgDelay=t.n?t.sumDelay/t.n:0,t},function(t,e){return--t.n,t.sumDelay-=Number(e.Delay),t.avgDelay=t.n?t.sumDelay/t.n:0,t},function(){return{n:0,sumDelay:0,avgDelay:0}}),averageDelay=i.groupAll().reduce(function(t,e){return++t.n,t.sumDelay+=Number(e.Delay),t},function(t,e){return--t.n,t.sumDelay-=Number(e.Delay),t},function(){return{n:0,sumDelay:0}});var p=d3.time.day(d.bottom(1)[0].DateTime),g=d3.time.day(d.top(1)[0].DateTime),y=g.setDate(g.getDate()+1);dc.dataCount("#resetAll").dimension(i).group(l).html({some:"<a class='btn btn-default btn-block'><i class='fa fa-chain-broken'></i> Reset All</a>",all:"<a class='btn btn-block btn-default disabled'><i class='fa fa-chain-broken'></i> Reset All</a>"}),dc.dataCount("#flights").dimension(i).group(l).html({some:"Total Flights: <strong>%filter-count</strong><small>/%total-count</small>",all:"Total Flights: <strong>%filter-count</strong><small> (all)</small>"}),totalAverageDelay.group(averageDelay).formatNumber(precisionFormat).valueAccessor(function(t){return t.n?t.sumDelay/t.n:0}),movementsChart.clipPadding(10).renderArea(!0).height(CHART_L-50).margins({top:5,right:30,bottom:20,left:25}).dimension(d).group(byDateHour).mouseZoomable(!0).elasticY(!0).x(d3.time.scale().domain([p,y])).renderHorizontalGridLines(!0).rangeChart(movementsTimeChart).brushOn(!1),movementsChart.xAxis().ticks(4),movementsChart.yAxis().ticks(6),movementsTimeChart.height(36).margins({top:0,right:30,bottom:17,left:25}).dimension(d).group(byDate).elasticY(!0).x(d3.time.scale().domain([p,y])).xUnits(d3.time.days).round(d3.time.day.round).xAxis().ticks(d3.time.days),flightDelay.height(CHART_L-9).margins({top:5,right:30,bottom:20,left:25}).clipPadding(10).dimension(m).group(byScatter).symbolSize(4).y(d3.scale.linear().domain([DELAY_MIN,DELAY_MAX+1])).x(d3.scale.linear().domain([0,24])).renderHorizontalGridLines(!0),flightDelay.yAxis().ticks(6),airportsChart.height(CHART_L).margins({top:0,right:25,bottom:17,left:5}).dimension(s).group(byScndAirport).rowsCap(9).elasticX(!0).ordering(function(t){return-t.value}).xAxis().ticks(3),weekdayChart.height(CHART_L).margins({top:0,right:25,bottom:17,left:5}).dimension(u).group(byWeekday).valueAccessor(function(t){return t.value.avgDelay}).elasticX(!0).label(function(t){return t.key.split(" ")[1]}).xAxis().ticks(3),delayChart.height(CHART_S).margins({top:0,right:25,bottom:17,left:10}).dimension(f).group(byDelay).elasticY(!0).x(d3.scale.linear().domain([DELAY_MIN,DELAY_MAX+1])).xUnits(function(){return(DELAY_MAX-DELAY_MIN)/5}).round(function(t){return r(t,5)}),todChart.height(CHART_S).margins({top:0,right:25,bottom:17,left:5}).dimension(c).group(byHour).elasticY(!0).x(d3.scale.linear().domain([0,24])).round(dc.round.floor),distanceChart.height(CHART_S).margins({top:0,right:30,bottom:17,left:5}).dimension(h).group(byDistance).elasticY(!0).x(d3.scale.linear().domain([0,DISTANCE_MAX+1])).xUnits(function(){return DISTANCE_MAX/100}).round(function(t){return r(t,100)}).xAxis().ticks(6),movementsChart.title(function(t){return"Date: "+dateOutFormat(t.key)+"\nNumber of Flights: "+numberFormat(t.value)}),airportsChart.title(function(t){return t.key+"\nNumber of Flights: "+numberFormat(t.value)}),weekdayChart.title(function(t){return t.key.split(" ")[1]+"\nMean Delay: "+precisionFormat(t.value.avgDelay)+" minutes\nNumber of Flights: "+numberFormat(t.value.n)}),resetableCharts=[movementsTimeChart,flightDelay,airportsChart,weekdayChart,todChart,delayChart,distanceChart],resetableCharts.forEach(function(t){t.on("preRedraw",function(t){a(t)}),$("#reset"+t.anchorName()).click(function(){t.filterAll(),dc.redrawAll()})}),flightsTable.size(20).dimension(airline).group(function(t){return d3.time.format("%d %B %Y")(t.DateTime)}).columns([{label:"Time",format:function(t){return d3.time.format("%H:%M")(t.DateTime)}},{label:"Delay",format:function(t){return t.Delay>0?"<span style='color:"+colorRange[0]+";'>+"+t.Delay+" min</span>":"<span style='color:"+colorRange[colorRange.length-1]+";'>"+t.Delay+" min</span>"}},{label:"Origin",format:function(t){return 1==t.Inbound?t.Airport2:t.Airport}},{label:"Destination",format:function(t){return 1!=t.Inbound?t.Airport2:t.Airport}},{label:"Airline",format:function(t){return t.Airline}},{label:"Distance",format:function(t){return d3.format("0,000")(t.Distance)+" miles"}},{label:"Type",format:function(t){return 1==t.Inbound?"Arrival":"Departure"}}]).sortBy(function(t){return-t.DateTime}).on("postRender",function(t){n(t)}).on("postRedraw",function(t){n(t)}),$(document).ready(o()),$("#resetAll").on("click",function(){dc.filterAll(),$("#airportSelect").val("ALL"),airport.filterAll(),$("#airlineSelect").val("ALL"),airline.filterAll(),dc.redrawAll()}),$(window).resize(function(){o()}),$("#airportSelect").on("change",function(){"ALL"==this.value?airport.filterAll():airport.filter(this.value),dc.redrawAll()}),$("#airlineSelect").on("change",function(){"ALL"==this.value?airline.filterAll():airline.filter(this.value),dc.redrawAll()});var D=!1;$("#colourflightDelay").on("click",function(){$(this).find("i").toggle(),D?(flightDelay.colors(d3.scale.category10().range()[0]),D=!1):(flightDelay.colors(colorRange),flightDelay.colorDomain([90,0]),flightDelay.colorAccessor(function(t){return t.key[1]}),D=!0),flightDelay.redraw()}),crosscompare.setHeight(500).setDateFormat("%d/%m %H:%M").addLegend("#airportSelect").addLegend("#airlineSelect").addLegend(movementsTimeChart).addLegend(airportsChart,"Airports").addLegend(delayChart,"Delay").add(movementsChart,{type:"area",yLabel:"Flights per Hour"}).add(airportsChart,{type:"bar",order:"desc",yLabel:"Flights",xLabel:"Connected Airports"}).add(weekdayChart,{type:"bar",value:"avgDelay",yLabel:"Average Delay",xLabel:"Day of Week"}).add(delayChart,{type:"bar",ratio:.2,yLabel:"Flights",xLabel:"Delay (min)"}).add(todChart,{type:"bar",ratio:.4,yLabel:"Flights",xLabel:"Time of Day (hour)"}).add(distanceChart,{type:"bar",ratio:.4,yLabel:"Flights",xLabel:"Distance (miles)"}),$(".openCross").on("click",function(){$("#crosscompareInfo").slideDown("fast")}),$(".closeCross").on("click",function(){$("#crosscompareInfo").slideUp("fast")}),$(".maxCrossCompare_open").on("click",function(){var t=.78*$(window).width();crosscompare.setWidth(t).render()}),$("#maxCrossCompare").popup({transition:"0.2s all 0.1s"}),$(".resetCrossCompare").on("click",function(){crosscompare.clear()})});var infoOptions={type:"tooltip",vertical:"bottom",horizontal:"right",offsetleft:-35,transition:"0.3s all 0.1s",closeelement:".info_close",tooltipanchor:$(".infoMovementsChart_open")};$("#infoMovementsChart").popup(infoOptions),infoOptions.horizontal="left",infoOptions.offsetleft=25,infoOptions.tooltipanchor=$(".infoflightDelay_open"),$("#infoflightDelay").popup(infoOptions),infoOptions.vertical="top",infoOptions.tooltipanchor=$(".infoDelayChart_open"),$("#infoDelayChart").popup(infoOptions),infoOptions.tooltipanchor=$(".infoTodChart_open"),$("#infoTodChart").popup(infoOptions),infoOptions.tooltipanchor=$(".infoDistanceChart_open"),$("#infoDistanceChart").popup(infoOptions),infoOptions.horizontal="right",infoOptions.offsetleft=-25,infoOptions.tooltipanchor=$(".infoairportsChart_open"),$("#infoairportsChart").popup(infoOptions),infoOptions.tooltipanchor=$(".infoWeekdayChart_open"),$("#infoWeekdayChart").popup(infoOptions);